{% extends "myapp/base.html" %}

{% block title %}Детали соревнования{% endblock %}

{% block content %}
<!-- main/templates/contest_detail_admin.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Contest:: {{ contest.name }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <!-- Сообщения -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endfor %}
    {% endif %}

    <h1>Contest:: {{ contest.name }}</h1>
    <a href="{% url 'contests' %}" class="btn btn-secondary mb-3">Назад к соревнованиям</a>
    <a href="{% url 'users_answers' contest.id %}" class="btn btn-info mb-3 ml-2">Результаты</a>

    <!-- Раздел для управления задачами -->
    <!-- Левый контейнер: список задач с нумерацией -->
    <div class="row">
        <div class="col-md-6">
            <h2>Задачи</h2>
            <ul class="list-group mb-4">
                {% for task in tasks %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <!-- Номер задачи и ссылка для отображения деталей -->
                    <span>{{ forloop.counter }}.
                        <a href="#" onclick="showTaskDetails({{ task.id }})"
                           {% if task.id in correct_answers %} style="color: green; font-weight: bold;" {% endif %}>
                           {{ task.name }}
                        </a>
                    </span>

                </li>
                {% empty %}
                <li class="list-group-item">Нет задач.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Правый контейнер: детали выбранной задачи -->
        <div class="col-md-6">
            <h2>Детали задачи</h2>
            <div id="task-details">

                <p>Выберите задачу, чтобы увидеть её детали.</p>

            </div>

            <!-- Блок для решения задачи -->
            <div class="col-md-12 mt-4" id="solve-task-block"
                 style="display: {% if selected_task_id %} block {% else %} none {% endif %};">
                <h2>Решить задачу</h2>
                <form method="post" action="{% url 'submit_answer' contest.id %}">
                    {% csrf_token %}

                    <!-- Скрытое поле для ID выбранной задачи -->
                    <input type="hidden" id="task_id_input" name="task_id" value="{{ selected_task_id }}">

                    <div class="form-group">
                        <label for="user_answer">Ваш ответ:</label>
                        <input type="text" class="form-control" id="user_answer" name="user_answer"
                               placeholder="Введите ваш ответ" required>
                    </div>
                    <button type="submit" class="btn btn-success">Отправить ответ</button>
                </form>

                {% if answer_result %}
                <div class="mt-3">
                    {% if answer_result.is_correct %}
                    <div class="alert alert-success" role="alert">
                        Верно! Поздравляем!
                    </div>
                    {% else %}
                    <div class="alert alert-danger" role="alert">
                        Неверно. Попробуйте снова.
                    </div>
                    {% endif %}
                </div>
                {% endif %}

            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const selectedTaskId = {{ selected_task_id|default:"None"}};
        if (selectedTaskId !== null) {
            showTaskDetails(selectedTaskId);
    }
    });
</script>

<script>
    function showTaskDetails(taskId) {
        // AJAX-запрос для получения деталей задачи
        fetch(`/tasks/${taskId}/details/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Сеть не ответила');
                }
                return response.json();
            })
            .then(data => {
                // Обновляем блок с деталями задачи
                const taskDetailsDiv = document.getElementById('task-details');
                taskDetailsDiv.innerHTML = `
                    <h3>${data.name}</h3>
                    <p>${data.condition}</p>
                `;

                // Устанавливаем ID задачи в скрытое поле формы
                document.getElementById('task_id_input').value = taskId;

                // Показываем блок для решения задачи
                document.getElementById('solve-task-block').style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка:', error);
                // Выводим сообщение об ошибке в блоке деталей задачи
                const taskDetailsDiv = document.getElementById('task-details');
                taskDetailsDiv.innerHTML = `
                    <p>Не удалось загрузить детали задачи. Пожалуйста, попробуйте снова.</p>
                `;
            });
    }
</script>


<!-- Подключение Bootstrap JS и зависимостей (опционально) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

{% endblock %}
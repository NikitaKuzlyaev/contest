{% extends "myapp/base.html" %}

{% block title %}Детали соревнования{% endblock %}

{% block content %}
<!-- main/templates/contest_detail_admin.html -->

<html lang="ru">
<head>
    <meta charset="UTF-8">

    <!-- Заголовок с отступами -->
    <div class="container mt-4 text-center">
        <h2 class="font-weight-bold">{{ contest.name }}</h2>
    </div>

    <!-- Подключение стилей и скриптов -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
</head>

<body>
<div class="container mt-4">
    <!-- Блок сообщений -->
    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Закрыть">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Кнопки навигации -->
    <div class="d-flex justify-content-center gap-3 mb-3">
        <a href="{% url 'contests' %}" class="btn btn-outline-secondary btn-lg shadow-sm">Назад к соревнованиям</a>
        <a href="{% url 'contest_detail_submissions' contest.id %}" class="btn btn-outline-primary btn-lg shadow-sm">
            Посылки
        </a>
        <a href="{% url 'contest_detail_results' contest.id %}" class="btn btn-outline-primary btn-lg shadow-sm">
            Результаты
        </a>
    </div>
</div>

<!--<p>Contest ID: {{ contest.id }}</p>-->
<!--<p>Page ID: {{ selected_page.id }}</p>-->

<div class="row mt-4">
    <!-- Левая панель с плашками вкладок -->
    <div class="col-md-4">
        <!-- Время проведения -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Время проведения</h5>
                <p class="card-text text-muted">
                    {{ contest.time_start|date:"d.m.Y H:i" }} — {{ contest.time_end|date:"d.m.Y H:i" }}
                </p>
            </div>
        </div>

        <!-- Таймер -->
        <div id="timer" class="alert alert-info text-center shadow-sm">
            <div id="timer-display" class="mt-2"></div>
        </div>

        <!-- Вкладки соревнования -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Вкладки соревнования</h5>
                {% if contest_pages %}
                <div class="list-group">
                    {% for page in contest_pages %}
                    <form method="post" action="{% url 'contest_detail' contest.id %}" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="select_page" value="{{ page.id }}">
                        <button type="button" class="list-group-item list-group-item-action tab-button shadow-sm"
                                data-tab-id="tab-{{ page.id }}">
                            <h6 class="mb-0">{{ page.title }}</h6>
                        </button>
                    </form>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Нет вкладок для этого соревнования.</p>
                {% endif %}
            </div>
        </div>

        <!-- Загрузить файл -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Загрузить файл</h5>
                <form method="post" enctype="multipart/form-data" action="{% url 'submit_file' %}">
                    {% csrf_token %}
                    <input type="hidden" name="select_page" value="{{ selected_page.id }}">
                    <input type="hidden" name="contest_id" value="{{ contest.id }}">
                    <div class="form-group">
                        <label for="fileInput" class="form-label">Выберите файл</label>
                        <input type="file" class="form-control" id="fileInput" name="file" accept=".csv">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Отправить</button>
                </form>
            </div>
        </div>
        <!--        &lt;!&ndash; Блок с выбором файла и кнопкой отправки &ndash;&gt;-->
        <!--        <h5>Загрузить файл</h5>-->
        <!--        <form method="post" enctype="multipart/form-data" action="{% url 'submit_file' %}">-->
        <!--            {% csrf_token %}-->
        <!--            <div class="form-group">-->
        <!--                <label for="fileInput">Выберите файл</label>-->
        <!--                <input type="hidden" name="select_page" value="{{ selected_page.id }}">-->
        <!--                <input type="hidden" name="contest_id" value="{{ contest.id }}">-->
        <!--                <input type="file" class="form-control-file" id="fileInput" name="file" accept=".csv">-->
        <!--            </div>-->
        <!--            <button type="submit" class="btn btn-primary">Отправить</button>-->
        <!--        </form>-->

    </div>

    <!-- Правая панель с формой для просмотра вкладки -->
    <!--<div class="col-md-8">
        &lt;!&ndash; Содержимое вкладки &ndash;&gt;
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="page_id" value="{{ selected_page.id }}">

            <div class="form-group">
                <div class="form-control-plaintext" style="white-space: pre-wrap;">
                    {{ selected_page.content }}
                </div>
            </div>
        </form>
    </div>-->
    <!-- Контент вкладок -->
    <div class="col-md-8" id="tab-content">
        {% for page in contest_pages %}
        <div class="tab-pane border rounded shadow-sm p-4 mb-3" id="tab-{{ page.id }}" style="display: none; background-color: #f9f9f9;">
            <!-- Заголовок вкладки -->
            <h4 class="mb-3 font-weight-bold text-primary">{{ page.title }}</h4>

            <!-- Содержимое вкладки -->
            <div class="form-control-plaintext" style="white-space: pre-wrap; font-size: 1rem; color: #333;">
                {{ page.content }}
            </div>
        </div>
        {% endfor %}
    </div>

</div>

</div>


<!-- Подключение Bootstrap JS и зависимостей (опционально) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!-- Добавляем стили -->
<style>
    .list-group-item {
        padding: 5px 10px; /* Уменьшаем отступы вокруг текста */
        font-size: 12px; /* Уменьшаем размер шрифта */
    }

    .list-group-item h5 {
        margin: 0; /* Убираем отступы у заголовков внутри вкладок */
    }
</style>


<style>
    .tab-button.active {
        background-color: #997bff;
        color: #fff;
    }
</style>


<script>
    // Переменная для хранения идентификатора интервала
    let intervalId;

    const contestStartDate = new Date("{{ contest.time_start|date:'Y-m-d H:i:s' }}").getTime();
    const contestEndDate = new Date("{{ contest.time_end|date:'Y-m-d H:i:s' }}").getTime();

    // Функция обновления таймера
    function updateTimer() {
        const now = new Date().getTime();  // Текущее время

        // Если текущее время меньше времени начала соревнования
        if (now < contestStartDate) {
            const timeLeft = contestStartDate - now;
            displayTime("До начала соревнования осталось:", timeLeft);
        }
        // Если текущее время находится между началом и концом соревнования
        else if (now >= contestStartDate && now < contestEndDate) {
            const timeLeft = contestEndDate - now;
            displayTime("До окончания соревнования осталось:", timeLeft);
        }
        // Если текущее время больше времени окончания соревнования
        else {
            clearInterval(intervalId);  // Останавливаем таймер
            document.getElementById("timer-display").innerHTML = "<strong>Соревнование завершено</strong>";
        }
    }

    // Функция отображения времени
    function displayTime(message, timeLeft) {
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));  // Часы
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));  // Минуты
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);  // Секунды

        // Форматируем время в HH:MM:SS
        const formattedTime =
            (hours < 10 ? '0' : '') + hours + ":" +
            (minutes < 10 ? '0' : '') + minutes + ":" +
            (seconds < 10 ? '0' : '') + seconds;

        // Обновляем текст таймера
        document.getElementById("timer-display").innerHTML = `
            <strong>${message}</strong>
            <h3>${formattedTime}</h3>
        `;
    }

    // Запуск таймера при загрузке страницы
    window.onload = function() {
        updateTimer();  // Сразу обновляем
        intervalId = setInterval(updateTimer, 200);  // Каждую секунду обновляем
    }
</script>


<script>
    // JavaScript для переключения вкладок
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // Функция переключения вкладок
        function activateTab(tabId) {
            // Убираем активный класс со всех кнопок и скрываем все вкладки
            tabs.forEach(tab => tab.classList.remove('active'));
            tabPanes.forEach(pane => pane.style.display = 'none');

            // Добавляем активный класс к текущей кнопке и показываем содержимое вкладки
            document.querySelector(`[data-tab-id="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).style.display = 'block';
        }

        // Устанавливаем обработчик нажатий на кнопки
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                activateTab(tab.getAttribute('data-tab-id'));
            });
        });

        // Активируем первую вкладку по умолчанию
        if (tabs.length > 0) {
            activateTab(tabs[0].getAttribute('data-tab-id'));
        }
    });
</script>


{% endblock %}